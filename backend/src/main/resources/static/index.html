<html>
	<head>
		<style>
			div { border:1px solid black; padding: 1px; overflow: hidden; }
			.breakdown { width: 500px; }
			.measurement { display: inline-block; }
			.measurements { overflow: scroll; white-space: nowrap; }
			.frame { border:1px solid purple; }
            #addNewMeasurement { height: 300px; width: 300px; display: block;}
		</style>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});

        document.addEventListener("DOMContentLoaded", function (ev) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    var datasourceList = JSON.parse(xmlHttp.responseText);
                    for (var i in datasourceList) {
                        var ds = datasourceList[i];
                        var opt = document.createElement("option");
                        opt.value = ds.name;
                        opt.text = ds.displayName;
                        document.getElementById("datasourceSelector").appendChild(opt);
                    }
                    datasourceSelected();
                }
            }
            xmlHttp.open( "GET", "http://localhost:8080/big/metadata/datasources", true ); // false for synchronous request
            xmlHttp.send( null );
            return xmlHttp.responseText;
		});

        function datasourceSelected() {
            var selectBox = document.getElementById("datasourceSelector");
            var selectedValue = selectBox.options[selectBox.selectedIndex].value;

            var myNode = document.getElementById("kpisSelector");
            while (myNode.firstChild) {
                myNode.removeChild(myNode.firstChild);
            }
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    var kpis = JSON.parse(xmlHttp.responseText);
                    for (var i in kpis) {
                        var kpi = kpis[i];
                        var opt = document.createElement("option");
                        opt.value = kpi.name;
                        opt.text = kpi.displayName;
                        document.getElementById("kpisSelector").appendChild(opt);
                    }
                }

            }
            xmlHttp.open( "GET", "http://localhost:8080/big/metadata/datasource/" + selectedValue + "/kpi/list", true );
            xmlHttp.send( null );
            return xmlHttp.responseText;
        }

        function addNewMeasurement() {
            var selectBox = document.getElementById("datasourceSelector");
            var selectedDatasource = selectBox.options[selectBox.selectedIndex].value;

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function() {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                    var dataResponse = JSON.parse(xmlHttp.responseText);
                    var header = []

                    var dimensionIndex = 0;
                    for (var i in dataResponse.header) {
                        var h = dataResponse.header[i]
                        if (h.kpi === null) {
                            dimensionIndex = i;
                            break;
                        }
                    }

                    header.push(dataResponse.header[dimensionIndex].dimension);
                    for (var i in dataResponse.header) {
                        var h = dataResponse.header[i]
                        if (i != dimensionIndex) {
                            header.push(h.kpi);
                        }
                    }

                    var dataMatrix = [];
                    for (var i in dataResponse.dataMatrix) {
                        var row = dataResponse.dataMatrix[i]
                        var dataRow = []
                        dataRow.push(row[dimensionIndex])
                        for (var j in row) {
                            if (j != dimensionIndex) {
                                var val = parseFloat(row[j]);
                                if(val == parseInt(row[j])) {
                                    val = parseInt(row[j]);
                                }

                                dataRow.push(val)
                            }
                        }
                        dataMatrix.push(dataRow);
                    }

                    drawChart(header, dataMatrix);
                }
            }
            xmlHttp.open( "POST", "http://localhost:8080/big/data", true );
            xmlHttp.setRequestHeader("Content-type", "application/json");
            var params = {"datasource": selectedDatasource,
                "kpis": [{"name": "temperature", "offeredMetric": "min"}],
                "dimensions": [{"name": "thunder"}]};
            xmlHttp.send( JSON.stringify(params));
            return xmlHttp.responseText;
        }

        function drawChart(header, dataMatrix) {
            var mix = [];
            mix.push(header);
            for(var i in dataMatrix) {
                mix.push(dataMatrix[i]);
            }
            var data = google.visualization.arrayToDataTable(mix);

            var options = {
                title: 'My Daily Activities'
            };

            var chart = new google.visualization.ColumnChart(document.getElementById('piechart'));
            chart.draw(data, options);
        }

	</script>
	</head>
	<body>
		<div id="title"><h1>BIG data-analyzer</h1></div>
		<div class="frame">
			<div class="measurements" id="measurements">
				<div class="measurement" id="measurement1">
					<div class="measurementTitle"><h2>Measurement 1</h2></div>
					<div class="breakdown" id="piechart">
					</div>
					<div class="measurementFooterButtons"><button id="newBreakdown" onclick="addNewBreakdown()">Button</button></div>
				</div>
				<div id="addNewMeasurement">
					<h2>Add new measurement</h2>
					<select id="datasourceSelector" onchange="datasourceSelected()">
					</select>
					<br>
					<select id="kpisSelector" multiple>
					</select>
					<button id="newMeasurementButton" onclick="addNewMeasurement()">Add new</button>
				</div>
			</div>
		</div>
	</body>
</html>